<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Status Dashboard</title>
    <!-- 1. Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Google API Client & Identity Services -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    

    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
        }
        .dashboard-card {
            transition: all 0.3s ease;
            border-radius: 0.75rem; /* More rounded */
            border-width: 1px;
            font-weight: 500;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
        }
        
        /* NEW Status Badge Colors */
        .status-confirm, .status-confirm-from-pendir { background-color: #c6f6d5; color: #2f855a; } /* Green */
        .status-cancelled { background-color: #fed7d7; color: #c53030; } /* Red */
        .status-pending, .status-need-to-call { background-color: #fefcbf; color: #b7791f; } /* Yellow */
        .status-delivered { background-color: #c6f6d5; color: #2f855a; } /* Green */
        .status-return { background-color: #e2e8f0; color: #4a5568; } /* Gray */
        .status-dispatched { background-color: #bee3f8; color: #2b6cb0; } /* Blue */
        .status-no-response { background-color: #4a5568; color: #f7fafc; } /* Dark Gray */
        .status-unknown { background-color: #edf2f7; color: #a0aec0; }
        
        /* NEW Dashboard Card Colors (from screenshot) */
        .card-dispatched { background-color: #ebf8ff; border-color: #bee3f8; }
        .card-cancelled { background-color: #fff5f5; border-color: #fed7d7; }
        .card-return { background-color: #f7fafc; border-color: #e2e8f0; }
        .card-delivered { background-color: #f0fff4; border-color: #c6f6d5; }
        .card-no-response { background-color: #4a5568; border-color: #2d3748; color: white; }
        .card-not-confirm { background-color: #f7fafc; border-color: #e2e8f0; }
        .card-confirm { background-color: #e6fffa; border-color: #b2f5ea; }
        .card-need-to-call { background-color: #fefcbf; border-color: #faf089; }
        .card-pending { background-color: #fefcbf; border-color: #faf089; }
        .card-unknown { background-color: #f7fafc; border-color: #e2e8f0; }
        .card-default { background-color: #ffffff; border-color: #e2e8f0; }
        
        /* Modal Scroll */
        .modal-body-scroll {
            max-height: 40vh;
            overflow-y: auto;
        }

    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Global Loader -->
    <div id="loader" class="fixed inset-0 bg-white bg-opacity-75 z-[100] flex items-center justify-center hidden backdrop-blur-sm">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
    </div>

    <!-- Global Error Box -->
    <div id="error-box" class="fixed top-5 right-5 w-full max-w-sm bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg hidden z-[101]" role="alert">
        <strong class="font-bold">Error:</strong>
        <span id="error-message" class="block sm:inline">Something went wrong.</span>
        <span id="close-error" class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer">
            <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
        </span>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center" style="background-color: #0b1120;">
        <div class="bg-white p-10 md:p-12 rounded-lg shadow-2xl max-w-md w-full mx-4">
            <h1 class="text-4xl font-bold text-gray-800 mb-6">Swedzo Pakistan</h1>
            <p class="text-gray-600 mb-8">Please sign in with Google to manage your orders.</p>
            <button id="login-button" class="w-full bg-gray-400 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-lg flex items-center justify-center space-x-3 cursor-not-allowed" disabled>
                <!-- Google G Logo SVG -->
                <svg class="w-6 h-6" viewBox="0 0 48 48">
                    <path fill="#4285F4" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path>
                    <path fill="#FBBC05" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path>
                    <path fill="#E84335" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path>
                    <path fill="#34A853" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C39.927,34.551,44,29.63,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
                </svg>
                <span>Loading Libraries...</span>
            </button>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div id="app-container" class="p-4 md:p-8 max-w-full 2xl:max-w-screen-2xl mx-auto hidden">
        
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Order Management Dashboard</h1>
            <p class="text-lg text-gray-600 mt-1">Live data from your Google Sheet</p>
        </header>

        <!-- Status Overview -->
        <section id="dashboard-stats" class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Status Overview</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                <!-- Cards will be injected by JS -->
                <div class="p-4 rounded-lg border bg-gray-100 shadow-sm animate-pulse h-28"></div>
                <div class="p-4 rounded-lg border bg-gray-100 shadow-sm animate-pulse h-28"></div>
                <div class="p-4 rounded-lg border bg-gray-100 shadow-sm animate-pulse h-28"></div>
                <div class="p-4 rounded-lg border bg-gray-100 shadow-sm animate-pulse h-28"></div>
                <div class="p-4 rounded-lg border bg-gray-100 shadow-sm animate-pulse h-28"></div>
                <div class="p-4 rounded-lg border bg-gray-100 shadow-sm animate-pulse h-28"></div>
            </div>
        </section>

        <!-- Orders List -->
        <section id="orders-list">
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                <h2 id="orders-list-title" class="text-2xl font-semibold text-gray-700">All Orders</h2>
                <div class="flex space-x-2">
                    <button id="show-all-button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 hidden">
                        Show All
                    </button>
                    <button id="refresh-button" class="bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-800 transition duration-300">
                        &#x21bb; Refresh
                    </button>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be injected by JS -->
                            <tr>
                                <td colspan="7" class="px-6 py-4 text-center text-gray-500">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <!-- Edit Row Modal (Completely new structure) -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-3xl shadow-lg rounded-lg bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-semibold text-gray-800">Edit Full Order</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
            </div>
            
            <!-- Modal Content -->
            <div class="space-y-4">
                
                <!-- Key Fields -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Customer (D)</label>
                        <input type="text" id="modal-col-D" class="mt-1 p-2 w-full border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Phone (E)</label>
                        <input type="text" id="modal-col-E" class="mt-1 p-2 w-full border border-gray-300 rounded-md shadow-sm">
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Product (C)</label>
                        <input type="text" id="modal-col-C" class="mt-1 p-2 w-full border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Address (F)</label>
                    <textarea id="modal-col-F" rows="2" class="mt-1 p-2 w-full border border-gray-300 rounded-md shadow-sm"></textarea>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Price (B)</label>
                        <input type="text" id="modal-col-B" class="mt-1 p-2 w-full border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Quantity (H)</label>
                        <input type="text" id="modal-col-H" class="mt-1 p-2 w-full border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Status (N)</label>
                        <select id="modal-col-N" class="mt-1 block w-full p-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <!-- Options based on your screenshot -->
                            <option>Confirm</option>
                            <option>Cancelled</option>
                            <option>Pending</option>
                            <option>Delivered</option>
                            <option>Return</option>
                            <option>Dispatched</option>
                            <option>Confirm From Pendir</option>
                            <option>No Response</option>
                            <option>Need to call</option>
                        </select>
                    </div>
                </div>
                
                <!-- Other Fields (Scrollable) -->
                <div class="border-t pt-4">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Other Fields</h4>
                    <div class="modal-body-scroll p-4 bg-gray-50 rounded-lg border">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- All 18 columns will be generated here -->
                            <div id="modal-other-fields"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden field to store the row index -->
                <input type="hidden" id="modal-row-index">

                <div class="pt-4 flex justify-end space-x-3">
                    <button id="cancel-edit" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancel</button>
                    <button id="save-changes-button" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300">Save Changes</button>
                </div>
            </div>
        </div>
    </div>


    <!-- ================================== -->
    <!-- JAVASCRIPT LOGIC -->
    <!-- ================================== -->
    <script type="module">
        // --- Google API Config ---
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        // --- Config & DOM Elements ---
        let config = {
            apiKey: 'AIzaSyB02r6MUhOUuK_DscBqmkm0AcAG2ogwJ4k',
            clientId: '205927545741-s36gk3l2drn9vp57b30gb04sn4qto4rh.apps.googleusercontent.com',
            spreadsheetId: '1ipmC-pPp17L-KdhQ7P_-XJjN_V1TQLC7XX_1bhWn1rg',
            range: 'Gadgets!A2:R' // Fetch columns A through R
        };
        
        // --- DOM Elements ---
        const loginScreen = document.getElementById('login-screen');
        const loginButton = document.getElementById('login-button');
        const loader = document.getElementById('loader');
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');
        const closeErrorButton = document.getElementById('close-error');
        const appContainer = document.getElementById('app-container');
        const refreshButton = document.getElementById('refresh-button');
        const showAllButton = document.getElementById('show-all-button');
        const ordersListTitle = document.getElementById('orders-list-title');
        const dashboardStats = document.getElementById('dashboard-stats').querySelector('div');
        const ordersTableBody = document.getElementById('orders-table-body');
        
        // Modal elements
        const editModal = document.getElementById('edit-modal');
        const closeModalButton = document.getElementById('close-modal');
        const cancelEditButton = document.getElementById('cancel-edit');
        const saveChangesButton = document.getElementById('save-changes-button'); // Renamed
        const modalRowIndex = document.getElementById('modal-row-index');
        const modalOtherFields = document.getElementById('modal-other-fields');

        // Store all sheet data
        let allOrdersData = [];
        let currentFilter = null; // Store the current filter status
        const TOTAL_COLUMNS = 18; // A-R

        // Column headers (assuming from your sheet)
        // A=0, B=1, C=2, D=3, E=4, F=5, G=6, H=7, I=8... N=13
        const COLUMN_NAMES = [
            'Orders (A)', 'Price (B)', 'Product (C)', 'Name (D)', 'Number (E)', 
            'Address (F)', 'City (G)', 'Quantity (H)', 'Item (I)', 'Col (J)', 
            'Col (K)', 'Col (L)', 'Col (M)', 'Status (N)', 'Col (O)', 
            'Col (P)', 'Col (Q)', 'Col (R)'
        ];
        
        // Key column indices
        const PRICE_COL = 1;
        const PRODUCT_COL = 2;
        const CUSTOMER_COL = 3;
        const PHONE_COL = 4;
        const ADDRESS_COL = 5;
        const QUANTITY_COL = 7;
        const STATUS_COL = 13;


        // --- App Initialization ---
        
        window.gapiLoaded = () => {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: config.apiKey,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            checkReady();
        }

        window.gisLoaded = () => {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: config.clientId,
                scope: SCOPES,
                callback: '', // Will be set dynamically
            });
            gisInited = true;
            checkReady();
        }
        
        function checkReady() {
            if (gapiInited && gisInited) {
                loginButton.disabled = false;
                loginButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                loginButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                loginButton.querySelector('span').textContent = 'Sign In with Google';
                console.log("Google services ready.");
            }
        }
        
        // --- Authentication ---
        loginButton.onclick = () => {
            tokenClient.callback = async (resp) => {
                if (resp.error) {
                    showError(resp.error.message || "An authentication error occurred.");
                    return;
                }
                gapi.client.setToken(resp);
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loadData(); // Load sheet data *after* sign-in
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        };


        // --- Data Loading & Processing ---

        async function loadData() {
            showLoader(true);
            hideError();
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: config.spreadsheetId,
                    range: config.range,
                });
                
                // Store raw data WITH original index
                allOrdersData = (response.result.values || []).map((row, index) => ({
                    // Ensure row has all 18 columns, padding with empty strings
                    rowData: Array.from({ length: TOTAL_COLUMNS }, (_, i) => row[i] || ''),
                    originalIndex: index // This is the 0-based index from the A2:R range
                }));
                
                console.log("Sheet data loaded:", allOrdersData.length, "rows");

                processDashboardStats();
                renderTable(); // Initial render
            
            } catch (err) {
                showError(err.result.error.message);
                console.error(err);
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
            } finally {
                showLoader(false);
            }
        }

        // Processes dashboard stats only
        function processDashboardStats() {
            const statusCounts = {};
            allOrdersData.forEach(item => {
                const row = item.rowData;
                const status = row[STATUS_COL] || 'Unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            renderDashboard(statusCounts);
            
            // Re-add event listeners to new filter cards
            document.querySelectorAll('.filter-card').forEach(card => {
                card.addEventListener('click', handleFilterClick);
            });
        }

        // Renders the table based on current state
        function renderTable() {
            let ordersHtml = '';
            
            const dataToRender = currentFilter 
                ? allOrdersData.filter(item => (item.rowData[STATUS_COL] || 'Unknown') === currentFilter)
                : allOrdersData;

            if (dataToRender.length === 0) {
                const message = currentFilter ? "No orders match this filter." : "No data found in sheet.";
                ordersHtml = `<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">${message}</td></tr>`;
            } else {
                dataToRender.forEach(item => {
                    const row = item.rowData;
                    const originalIndex = item.originalIndex; // This is the key
                    
                    const customer = row[CUSTOMER_COL] || 'N/A';
                    const phone = row[PHONE_COL] || 'N/A';
                    const address = row[ADDRESS_COL] || 'N/A';
                    const product = row[PRODUCT_COL] || 'N/A';
                    const price = row[PRICE_COL] || 'N/A';
                    const status = row[STATUS_COL] || 'Unknown';

                    // Create table row
                    ordersHtml += `
                        <tr class="hover:bg-gray-50" data-row-index="${originalIndex}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${customer}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-700">${phone}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap max-w-xs truncate">
                                <div class="text-sm text-gray-700" title="${address}">${address}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap max-w-xs truncate">
                                <div class="text-sm text-gray-700" title="${product}">${product}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-700">${price}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                ${getStatusBadge(status)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button class="edit-btn text-indigo-600 hover:text-indigo-900">Edit</button>
                            </td>
                        </tr>
                    `;
                });
            }

            ordersTableBody.innerHTML = ordersHtml;

            // Add event listeners to new edit buttons
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', handleEditClick);
            });
        }

        function renderDashboard(counts) {
            let dashboardHtml = '';
            // NEW Dashboard Card Colors (from screenshot)
            const cardColors = {
                'Dispatched': 'card-dispatched',
                'Cancelled': 'card-cancelled',
                'Return': 'card-return',
                'Delivered': 'card-delivered',
                'No Response': 'card-no-response',
                'Not confirm': 'card-not-confirm',
                'Confirm': 'card-confirm',
                'Need to call': 'card-need-to-call',
                'Pending': 'card-pending',
                'Unknown': 'card-unknown',
                // Add more mappings from your screenshots
            };

            // Create a sorted list of statuses
            const sortedStatuses = Object.keys(counts).sort((a, b) => {
                // You can add custom sorting logic here if needed
                return a.localeCompare(b);
            });

            for (const status of sortedStatuses) {
                const count = counts[status];
                // Find a matching class or use default
                const colorClass = Object.keys(cardColors).find(key => status.toLowerCase().includes(key.toLowerCase())) 
                                   ? cardColors[Object.keys(cardColors).find(key => status.toLowerCase().includes(key.toLowerCase()))]
                                   : 'card-default';
                
                const textColor = colorClass.includes('no-response') ? 'text-white' : 'text-gray-900';
                const subTextColor = colorClass.includes('no-response') ? 'text-gray-200' : 'text-gray-600';

                dashboardHtml += `
                    <div data-status="${status}" class="filter-card dashboard-card p-5 ${colorClass} shadow-sm cursor-pointer hover:opacity-80">
                        <div class="text-4xl font-bold ${textColor}">${count}</div>
                        <div class="text-sm font-medium ${subTextColor} mt-1">${status}</div>
                    </div>
                `;
            }
            dashboardStats.innerHTML = dashboardHtml;
        }

        function getStatusBadge(status) {
            let statusClass = 'status-unknown';
            if (status) {
                statusClass = 'status-' + status.toLowerCase().replace(/ /g, '-');
            }
            return `<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                        ${status || 'Unknown'}
                    </span>`;
        }

        // --- Editing Logic (NEW: Full Row Edit) ---

        function handleEditClick(event) {
            const rowIndex = event.target.closest('tr').getAttribute('data-row-index');
            
            const itemData = allOrdersData[rowIndex];
            if (!itemData) return;
            
            const rowData = itemData.rowData;
            
            // Populate key fields
            document.getElementById('modal-col-D').value = rowData[CUSTOMER_COL];
            document.getElementById('modal-col-E').value = rowData[PHONE_COL];
            document.getElementById('modal-col-C').value = rowData[PRODUCT_COL];
            document.getElementById('modal-col-F').value = rowData[ADDRESS_COL];
            document.getElementById('modal-col-B').value = rowData[PRICE_COL];
            document.getElementById('modal-col-H').value = rowData[QUANTITY_COL];
            document.getElementById('modal-col-N').value = rowData[STATUS_COL];
            
            // Populate "Other Fields"
            let otherFieldsHtml = '';
            const keyFieldIndices = [CUSTOMER_COL, PHONE_COL, PRODUCT_COL, ADDRESS_COL, PRICE_COL, QUANTITY_COL, STATUS_COL];
            
            for(let i = 0; i < TOTAL_COLUMNS; i++) {
                if (keyFieldIndices.includes(i)) continue; // Skip fields already shown
                
                otherFieldsHtml += `
                    <div>
                        <label class="block text-sm font-medium text-gray-700">${COLUMN_NAMES[i]}</label>
                        <input type="text" id="modal-col-${i}" class="mt-1 p-2 w-full border border-gray-300 rounded-md shadow-sm" value="${rowData[i]}">
                    </div>
                `;
            }
            modalOtherFields.innerHTML = otherFieldsHtml;

            // Store the original row index from the data array
            modalRowIndex.value = rowIndex; 
            showModal(true);
        }
        
        
        // Handle modal close (save or cancel)
        function handleModalClose(isSaving = false) {
            showModal(false);
            
            if (isSaving) {
                loadData(); // Reload all data to show changes
            }
        }

        // NEW: Save all changes in the modal
        async function handleSaveChanges() {
            showLoader(true);
            const originalDataRowIndex = parseInt(modalRowIndex.value);
            // The sheet is 1-indexed, and we have a header row (A2), so add 2
            const sheetRowNumber = originalDataRowIndex + 2; 
            
            // Re-construct the full row array from all 18 modal inputs
            let updatedRowData = [];
            for(let i = 0; i < TOTAL_COLUMNS; i++) {
                const inputElement = document.getElementById(`modal-col-${i}`) || document.getElementById(`modal-col-${String.fromCharCode(65 + i)}`); // Find 'modal-col-A', 'modal-col-0', etc.
                if (inputElement) {
                    updatedRowData.push(inputElement.value);
                } else {
                    // Fallback for any missing inputs (should not happen, but safe)
                    updatedRowData.push(allOrdersData[originalDataRowIndex].rowData[i]);
                }
            }

            const updateRange = `Gadgets!A${sheetRowNumber}:R${sheetRowNumber}`; 

            try {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: config.spreadsheetId,
                    range: updateRange,
                    valueInputOption: 'RAW',
                    resource: {
                        values: [updatedRowData] // Send the entire row as an array within an array
                    },
                });
                
                // Success! Close modal and refresh data
                handleModalClose(true); // Pass true to signal refresh
                
            } catch (err) {
                showError(err.result.error.message);
                console.error(err);
            } finally {
                showLoader(false);
            }
        }
        
        // --- Filter Logic ---
        function handleFilterClick(event) {
            const status = event.currentTarget.getAttribute('data-status');
            currentFilter = status; // Set global filter
            
            renderTable(); // Re-render table with new filter
            
            // Update UI
            ordersListTitle.textContent = `Filtered Orders: ${status}`;
            showAllButton.classList.remove('hidden');
        }

        function handleShowAll() {
            currentFilter = null; // Clear global filter
            renderTable(); // Re-render with all data

            // Update UI
            ordersListTitle.textContent = 'All Orders';
            showAllButton.classList.add('hidden');
        }

        // --- UI Helpers ---
        function showLoader(show) {
            loader.classList.toggle('hidden', !show);
        }
        function showError(message) {
            errorMessage.textContent = message;
            errorBox.classList.remove('hidden');
        }
        function hideError() {
            errorBox.classList.add('hidden');
        }
        function showModal(show) {
            editModal.classList.toggle('hidden', !show);
        }

        // --- Event Listeners ---
        refreshButton.addEventListener('click', loadData);
        showAllButton.addEventListener('click', handleShowAll);
        closeModalButton.addEventListener('click', () => handleModalClose(false));
        cancelEditButton.addEventListener('click', () => handleModalClose(false));
        saveChangesButton.addEventListener('click', handleSaveChanges); // Updated listener
        closeErrorButton.addEventListener('click', hideError);

        // --- Start App ---
        // Google API scripts will call their respective `...Loaded` functions when ready

    </script>
</body>
</html>
